<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ZEWEIL Private Chat</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body {
      background-color: #111;
      color: white;
      font-family: Tahoma;
      padding: 20px;
    }

    h2 { color: #0f0; margin-bottom: 10px; }

    #main {
      display: flex;
    }

    #sidebar {
      width: 200px;
      background-color: #1a1a1a;
      padding: 10px;
      border-radius: 10px;
      margin-left: 10px;
      height: 500px;
      overflow-y: auto;
    }

    .user-status {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
      border: 1px solid #fff;
    }

    .online { background-color: #0f0; }
    .offline { background-color: #aaa; }

    #chat-box {
      flex: 1;
      height: 500px;
      overflow-y: auto;
      background: #1a1a1a;
      border-radius: 10px;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }

    .message {
      max-width: 80%;
      padding: 10px 15px;
      margin: 8px 0;
      border-radius: 15px;
      position: relative;
      word-wrap: break-word;
      line-height: 1.4;
    }

    .my-message {
      background-color: #0f0;
      color: #000;
      align-self: flex-end;
      border-bottom-right-radius: 0;
    }

    .other-message {
      background-color: #333;
      color: #fff;
      align-self: flex-start;
      border-bottom-left-radius: 0;
    }

    .system-message {
      color: #888;
      font-style: italic;
      text-align: center;
    }

    .sender { font-weight: bold; font-size: 0.85em; }
    .time { font-size: 0.75em; opacity: 0.7; margin-top: 4px; text-align: right; }

    input, button {
      padding: 10px;
      border: none;
      border-radius: 5px;
      margin: 5px 0;
    }

    input { width: 60%; }
    #room { width: 200px; margin-bottom: 10px; }

    button {
      background-color: #0f0;
      color: black;
      cursor: pointer;
    }

    .reactions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 5px;
    }

    .reaction {
      font-size: 14px;
      background: #444;
      padding: 2px 6px;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <h2>🔐 دردشة ZEWEIL الخاصة</h2>

  <input type="text" id="room" placeholder="🛡️ كود الغرفة">
  <input type="text" id="username" placeholder="🡩‍💬 اسمك">
  <button onclick="joinRoom()">انضم</button>

  <div id="main">
    <div id="chat-box"></div>
    <div id="sidebar">
      <h4>👥 الأعضاء</h4>
      <div id="user-list"></div>
    </div>
  </div>

  <input type="text" id="message" placeholder="💬 رسالتك">
  <button onclick="sendMessage()">إرسال</button>
  <button onclick="startCall()">📹 مكالمة فيديو</button>
  <button onclick="startVoiceCall()">📞 مكالمة صوتية</button>

  <script>
    const firebaseConfig = {
      databaseURL: "https://zeweil-chat-default-rtdb.europe-west1.firebasedatabase.app/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentRoom = "";
    let currentUser = "";

    function joinRoom() {
      const room = document.getElementById("room").value.trim();
      const name = document.getElementById("username").value.trim();
      if (!room || !name) return;

      currentRoom = room;
      currentUser = name;

      localStorage.setItem("roomCode", room);
      localStorage.setItem("userName", name);

      db.ref("rooms/" + room).push({
        name: "🚪 النظام",
        message: `📢 لقد انضم ${name}`,
        time: new Date().toLocaleTimeString(),
        system: true
      });

      // حفظ حالة الاتصال
      db.ref(`activeUsers/${room}/${name}`).set(true);
      db.ref(`activeUsers/${room}/${name}`).onDisconnect().set(false);

      loadMessages();
      loadUsers();
    }

    function sendMessage() {
      const msg = document.getElementById("message").value.trim();
      if (!currentRoom || !currentUser || !msg) return;
      db.ref("rooms/" + currentRoom).push({
        name: currentUser,
        message: msg,
        time: new Date().toLocaleTimeString(),
        reactions: {}
      });
      document.getElementById("message").value = "";
    }

    function loadMessages() {
      document.getElementById("chat-box").innerHTML = "";
      db.ref("rooms/" + currentRoom).on("child_added", (snapshot) => {
        const data = snapshot.val();

        const msgDiv = document.createElement("div");
        msgDiv.classList.add("message");

        if (data.system) {
          msgDiv.classList.add("system-message");
          msgDiv.textContent = data.message;
          document.getElementById("chat-box").appendChild(msgDiv);
          document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
          return;
        }

        msgDiv.classList.add(data.name === currentUser ? "my-message" : "other-message");

        const reactionsDiv = document.createElement("div");
        reactionsDiv.className = "reactions";
        if (data.reactions) {
          Object.entries(data.reactions).forEach(([emoji, users]) => {
            if (users.length > 0) {
              const r = document.createElement("div");
              r.className = "reaction";
              r.textContent = `${emoji} ${users.length}`;
              reactionsDiv.appendChild(r);
            }
          });
        }

        msgDiv.innerHTML = `
          <div class="sender">${data.name}</div>
          ${data.message}
          <div class="time">${data.time}</div>
        `;
        msgDiv.appendChild(reactionsDiv);
        document.getElementById("chat-box").appendChild(msgDiv);
        document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
      });
    }

    function loadUsers() {
      const userList = document.getElementById("user-list");
      db.ref(`activeUsers/${currentRoom}`).on("value", (snapshot) => {
        userList.innerHTML = "";
        snapshot.forEach(child => {
          const name = child.key;
          const online = child.val();

          const userDiv = document.createElement("div");
          userDiv.className = "user-status";

          const dot = document.createElement("div");
          dot.className = "status-dot " + (online ? "online" : "offline");

          const span = document.createElement("span");
          span.textContent = name;

          userDiv.appendChild(dot);
          userDiv.appendChild(span);
          userList.appendChild(userDiv);
        });
      });
    }

    function startCall() {
      const room = document.getElementById("room").value.trim();
      if (room) window.open("https://meet.jit.si/" + room, "_blank");
    }

    function startVoiceCall() {
      const room = document.getElementById("room").value.trim();
      if (room) window.open("https://meet.jit.si/" + room + "-voice", "_blank");
    }

    window.addEventListener('beforeunload', function () {
      const userName = localStorage.getItem('userName');
      const roomCode = localStorage.getItem('roomCode');

      if (userName && roomCode) {
        db.ref("rooms/" + roomCode).push({
          name: "🚪 النظام",
          message: `🚪 لقد غادر ${userName}`,
          time: new Date().toLocaleTimeString(),
          system: true
        });
        db.ref(`activeUsers/${roomCode}/${userName}`).set(false);
      }
    });
  </script>
</body>
</html>
