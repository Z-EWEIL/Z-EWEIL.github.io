<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>ZEWEIL Private Chat</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <style>
    body {
      background-color: #111;
      color: white;
      font-family: Tahoma;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h2 {
      color: #0f0;
      margin-bottom: 10px;
    }
    #chat-box {
      width: 90%;
      max-width: 600px;
      height: 400px;
      overflow-y: auto;
      background: #1a1a1a;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      display: flex;
      flex-direction: column;
    }
    .message {
      max-width: 80%;
      padding: 10px 15px;
      margin: 8px 0;
      border-radius: 15px;
      position: relative;
      word-wrap: break-word;
      line-height: 1.4;
    }
    .my-message {
      background-color: #0f0;
      color: #000;
      align-self: flex-end;
      border-bottom-right-radius: 0;
    }
    .other-message {
      background-color: #333;
      color: #fff;
      align-self: flex-start;
      border-bottom-left-radius: 0;
    }
    .sender {
      font-weight: bold;
      font-size: 0.85em;
      display: flex;
      align-items: center;
    }
    .time {
      font-size: 0.75em;
      opacity: 0.7;
      margin-top: 4px;
      text-align: right;
    }
    .system-message {
      color: #888;
      font-style: italic;
      text-align: center;
    }
    input,
    button {
      padding: 10px;
      border: none;
      border-radius: 5px;
      margin: 5px;
    }
    input {
      width: 60%;
    }
    #room {
      width: 200px;
      margin-bottom: 10px;
    }
    button {
      background-color: #0f0;
      color: black;
      cursor: pointer;
    }
    .rank-icon {
      width: 50px;
      height: 50px;
      margin-left: 5px;
      vertical-align: middle;
    }
    #shopButton {
      position: fixed;
      top: 15px;
      right: 15px;
      background-color: #0f0;
      color: black;
      font-size: 24px;
      padding: 10px 14px;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 10px #0f0;
      transition: background-color 0.3s ease, transform 0.2s ease;
      z-index: 10000;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #shopButton:hover {
      background-color: #0c0;
      transform: scale(1.1);
    }
    #onlineToggle {
      position: absolute;
      left: 15px;
      top: 15px;
      background: #0f0;
      color: #000;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    #onlineList {
      position: absolute;
      left: 15px;
      top: 65px;
      background: #222;
      color: white;
      padding: 10px;
      border-radius: 8px;
      display: none;
      max-height: 300px;
      overflow-y: auto;
      min-width: 200px;
      z-index: 9999;
    }
  </style>
</head>
<body>

  <div id="onlineToggle">ğŸ‘¥</div>
  <div id="onlineList"></div>

  <a href="https://zeweil-chat.vercel.app/rank-shop.html" id="shopButton" title="Ù…ØªØ¬Ø± Ø§Ù„Ø±ØªØ¨">ğŸ›’</a>

  <h2>ğŸ” Ø¯Ø±Ø¯Ø´Ø© ZEWEIL Ø§Ù„Ø®Ø§ØµØ©</h2>

  <input type="text" id="room" placeholder="ğŸ›¡ï¸ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©" />
  <input type="text" id="username" placeholder="ğŸ¡©â€ğŸ’¬ Ø§Ø³Ù…Ùƒ" />
  <button onclick="joinRoom()">Ø§Ù†Ø¶Ù…</button>

  <div id="giftShop">
    <button onclick="window.open('https://app.fawaterk.com/paymentRequest/show/25451', '_blank')">ğŸ Ø´Ø±Ø§Ø¡ Ù†Ù‚Ø§Ø·</button>
    <span id="pointsDisplay">Ø±ØµÙŠØ¯Ùƒ: 0 ğŸ¯</span>
  </div>

  <div id="chat-box"></div>

  <input type="text" id="message" placeholder="ğŸ’¬ Ø±Ø³Ø§Ù„ØªÙƒ" />
  <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
  <button onclick="startCall()">ğŸ“¹ Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ</button>
  <button onclick="startVoiceCall()">ğŸ“ Ù…ÙƒØ§Ù„Ù…Ø© ØµÙˆØªÙŠØ©</button>

  <script>
    // Ù‡Ù†Ø§ ØªØ¨Ø¯Ø£ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ§Ù„ÙŠ...// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAlim9FOvDcMqTJWINoBCHk3k6DNXS-jTo",
  authDomain: "zeweil-chat.firebaseapp.com",
  databaseURL: "https://zeweil-chat-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "zeweil-chat",
  storageBucket: "zeweil-chat.appspot.com",
  messagingSenderId: "79843372176",
  appId: "1:79843372176:web:ea511efffae60c2a6cfc15",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentRoom = "";
let currentUser = "";
let userId = localStorage.getItem("savedUserId") || null;
let userRef = null;
let currentRank = "beginner";  // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø±ØªØ¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„
firebase.auth().onAuthStateChanged((user) => {
  if (user) {
    userId = user.uid;
    localStorage.setItem("savedUserId", userId);
    // Ù‡Ù†Ø§ Ù†Ø¨Ø¯Ø£ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø±ØªØ¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    watchUserRank();
  } else {
    firebase.auth().signInAnonymously().catch((error) => {
      console.error("Auth error:", error.message);
    });
  }
});

// Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ ØµÙˆØ±Ø© Ø§Ù„Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ø±ØªØ¨Ø©
function getRankImg(rank) {
  if (!rank) return "";
  const baseRaw = "https://raw.githubusercontent.com/Z-EWEIL/Zeweil_chat/main/";
  const filename = `${rank}.png`;
  return `<img src="${baseRaw}${filename}" alt="${rank}" class="rank-icon" />`;
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø±ØªØ¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function watchUserRank() {
  if (!userId) return;
  db.ref(`users/${userId}/rank`).on("value", (snapshot) => {
    const newRank = snapshot.val() || "beginner";
    if (newRank !== currentRank) {
      currentRank = newRank;
      console.log("Ø±ØªØ¨ØªÙƒ ØªØºÙŠØ±Øª Ø¥Ù„Ù‰:", currentRank);
      updateRankInUI(currentRank);
    }
  });
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØªØ¨Ø© ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙˆØ±Ø§Ù‹ (ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙØªÙˆØ­Ø©)
// 1- ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
// 2- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØªØ¨Ø© Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„

function updateRankInUI(rank) {
  // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (Ù„Ùˆ Ù‡ÙŠ Ø¸Ø§Ù‡Ø±Ø©)
  const list = document.getElementById("onlineList");
  if (list) {
    // Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©
    // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† ØªÙ†ÙÙŠØ° ØªØ­Ø¯ÙŠØ« ÙŠØ¯ÙˆÙŠ Ø£Ùˆ ØªØ±Ùƒ Ø§Ù„Ø£Ù…Ø± Ù„ØªØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø¹Ù†Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ± Ø¢Ø®Ø±
  }

  // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (Ù…Ø«Ù„Ø§Ù‹)
  const messages = document.querySelectorAll(".message");
  messages.forEach((msgDiv) => {
    const senderDiv = msgDiv.querySelector(".sender");
    if (!senderDiv) return;

    // ØªØ­Ù‚Ù‚ Ù‡Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¨Ø­ÙƒÙ… userId)
    if (msgDiv.dataset.userId === userId) {
      // ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ø±ØªØ¨Ø© Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø§Ø³Ù…
      const rankImgHTML = getRankImg(rank);
      // Ø§Ù„Ø§Ø³Ù… Ù…Ø¹ ØµÙˆØ±Ø© Ø§Ù„Ø±ØªØ¨Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      const name = currentUser || "";
      senderDiv.innerHTML = `${name} ${rankImgHTML}`;
    }
  });
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ DOM Ù…Ø¹ Ø¹Ø±Ø¶ Ø§Ù„Ø±ØªØ¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
function addMessageToDOM(key, data) {
  if (document.getElementById(key)) return;

  const msgDiv = document.createElement("div");
  msgDiv.id = key;
  msgDiv.classList.add("message");
  msgDiv.dataset.userId = data.userId || "";

  if (data.system) {
    msgDiv.classList.add("system-message");
    msgDiv.textContent = data.message;
    document.getElementById("chat-box").appendChild(msgDiv);
    document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
    return;
  }

  // Ø¬Ù„Ø¨ Ø§Ù„Ø±ØªØ¨Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙƒÙ„ Ø§Ø³Ù… (ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ†Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§)
  db.ref(`users`).orderByChild("name").equalTo(data.name).once("value", (snap) => {
    let rank = "beginner";
    snap.forEach((userSnap) => {
      if (userSnap.exists()) {
        rank = userSnap.val().rank || "beginner";
      }
    });

    const rankImg = getRankImg(rank);
    const isMyMessage = data.userId === userId;

    msgDiv.classList.add(isMyMessage ? "my-message" : "other-message");
    msgDiv.ondblclick = () => showEmojiPicker(msgDiv, key);

    msgDiv.innerHTML = `
      <div class="sender">${data.name} ${rankImg}</div>
      <div class="message-content">${data.message}</div>
      <div class="time">${data.time}</div>
    `;

    if (isMyMessage) {
      const editBtn = document.createElement("button");
      editBtn.textContent = "âœï¸";
      editBtn.title = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©";
      editBtn.style.marginLeft = "5px";
      editBtn.onclick = () => editMessage(key);

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "ğŸ—‘ï¸";
      deleteBtn.title = "Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©";
      deleteBtn.style.marginLeft = "5px";
      deleteBtn.onclick = () => deleteMessage(key);

      msgDiv.appendChild(editBtn);
      msgDiv.appendChild(deleteBtn);
    }

    const giftBtn = document.createElement("button");
    giftBtn.textContent = "ğŸ";
    giftBtn.onclick = () => sendGift(data.name);
    msgDiv.appendChild(giftBtn);

    const reactionsDiv = document.createElement("div");
    reactionsDiv.className = "reactions";
    if (data.reactions) {
      Object.entries(data.reactions).forEach(([emoji, users]) => {
        if (users.length > 0) {
          const r = document.createElement("div");
          r.className = "reaction";
          r.textContent = `${emoji} ${users.length}`;
          reactionsDiv.appendChild(r);
        }
      });
    }

    msgDiv.appendChild(reactionsDiv);
    document.getElementById("chat-box").appendChild(msgDiv);
    document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
  });
}

// Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ (updateMessageInDOM, removeMessageFromDOM, sendMessage, joinRoom, editMessage, deleteMessage, sendGift, addReaction, showEmojiPicker, startCall, startVoiceCall) ... 
// ÙŠØ¬Ø¨ ØªØ¶Ù…ÙŠÙ†Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ù† ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±

// ÙÙŠ Ø¯Ø§Ù„Ø© joinRoom() Ø¹Ù†Ø¯ ØªØ¹ÙŠÙŠÙ† userRef:
function joinRoom() {
  const room = document.getElementById("room").value.trim();
  const name = document.getElementById("username").value.trim();
  if (!room || !name || !userId) return;

  currentRoom = room;
  currentUser = name;
  userRef = db.ref(`rooms/${room}/users/${userId}`);
  const now = Date.now();

  // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ù…Ø©
  db.ref(`users/${userId}`)
    .once("value")
    .then((snapshot) => {
      if (snapshot.exists()) {
        db.ref(`users/${userId}`).update({ name: currentUser });
      } else {
        db.ref(`users/${userId}`).set({ name: currentUser, points: 0, rank: "beginner" });
      }
    });

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ØºØ±ÙØ© Ù…Ø¹ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±ØªØ¨Ø© (Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§ Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØªØ¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©)
  userRef.set({ name: currentUser, online: true, lastSeen: now, rank: currentRank });
  userRef.onDisconnect().update({
    online: false,
    lastSeen: firebase.database.ServerValue.TIMESTAMP,
  });

  // Ø§Ø³ØªÙ…Ø¹ Ø¹Ù„Ù‰ Ø±ØªØ¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…ÙƒØ±Ø± Ù„ÙƒÙ† Ù…Ø¶Ù…ÙˆÙ† Ù…Ø¹ onAuthStateChanged)
  watchUserRank();

  // Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© ...
  // ...
                                    }function updateMessageInDOM(key, data) {
  const msgDiv = document.getElementById(key);
  if (!msgDiv) return;

  if (data.system) {
    msgDiv.className = "message system-message";
    msgDiv.textContent = data.message;
    return;
  }

  db.ref(`users`).orderByChild("name").equalTo(data.name).once("value", (snap) => {
    let rank = "beginner";
    snap.forEach((userSnap) => {
      if (userSnap.exists()) {
        rank = userSnap.val().rank || "beginner";
      }
    });

    const rankImg = getRankImg(rank);
    const isMyMessage = data.userId === userId;

    msgDiv.className = "message";
    msgDiv.classList.add(isMyMessage ? "my-message" : "other-message");
    msgDiv.ondblclick = () => showEmojiPicker(msgDiv, key);

    msgDiv.innerHTML = `
      <div class="sender">${data.name} ${rankImg}</div>
      <div class="message-content">${data.message}</div>
      <div class="time">${data.time}</div>
    `;

    if (isMyMessage) {
      const editBtn = document.createElement("button");
      editBtn.textContent = "âœï¸";
      editBtn.title = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©";
      editBtn.style.marginLeft = "5px";
      editBtn.onclick = () => editMessage(key);

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "ğŸ—‘ï¸";
      deleteBtn.title = "Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©";
      deleteBtn.style.marginLeft = "5px";
      deleteBtn.onclick = () => deleteMessage(key);

      msgDiv.appendChild(editBtn);
      msgDiv.appendChild(deleteBtn);
    }

    const giftBtn = document.createElement("button");
    giftBtn.textContent = "ğŸ";
    giftBtn.onclick = () => sendGift(data.name);
    msgDiv.appendChild(giftBtn);

    const reactionsDiv = document.createElement("div");
    reactionsDiv.className = "reactions";
    if (data.reactions) {
      Object.entries(data.reactions).forEach(([emoji, users]) => {
        if (users.length > 0) {
          const r = document.createElement("div");
          r.className = "reaction";
          r.textContent = `${emoji} ${users.length}`;
          reactionsDiv.appendChild(r);
        }
      });
    }

    msgDiv.appendChild(reactionsDiv);
  });
}

function removeMessageFromDOM(key) {
  const msgDiv = document.getElementById(key);
  if (msgDiv) {
    msgDiv.remove();
  }
}

function sendMessage() {
  const msg = document.getElementById("message").value.trim();
  if (!currentRoom || !currentUser || !msg) return;
  db.ref("rooms/" + currentRoom + "/messages").push({
    userId: userId,
    name: currentUser,
    message: msg,
    time: new Date().toLocaleTimeString(),
    reactions: {},
  });
  document.getElementById("message").value = "";
}

function editMessage(msgKey) {
  const msgRef = db.ref(`rooms/${currentRoom}/messages/${msgKey}`);
  msgRef.once("value").then((snapshot) => {
    const data = snapshot.val();
    if (data.userId !== userId) {
      alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© Ù„ÙŠØ³Øª Ù„Ùƒ!");
      return;
    }

    const newMessage = prompt("Ø¹Ø¯Ù„ Ø±Ø³Ø§Ù„ØªÙƒ:", data.message);
    if (newMessage !== null) {
      msgRef.update({ message: newMessage });
    }
  });
}

function deleteMessage(msgKey) {
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ")) return;

  const msgRef = db.ref(`rooms/${currentRoom}/messages/${msgKey}`);
  msgRef.once("value").then((snapshot) => {
    const data = snapshot.val();
    if (data.userId !== userId) {
      alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© Ù„ÙŠØ³Øª Ù„Ùƒ!");
      return;
    }
    msgRef.remove();
  });
}

function sendGift(toUser) {
  const giftPrices = { "ğŸŒ¹": 5, "ğŸ‰": 10, "ğŸ’": 25, "ğŸ†": 50 };
  const emoji = prompt("Ø§Ø®ØªØ± Ù‡Ø¯ÙŠØ©: ğŸŒ¹ ğŸ‰ ğŸ’ ğŸ†");
  if (!giftPrices[emoji]) return alert("âŒ Ù‡Ø¯ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©");

  const userPointsRef = db.ref(`users/${userId}/points`);
  userPointsRef.once("value", (snap) => {
    const currentPoints = snap.val() || 0;
    const cost = giftPrices[emoji];
    if (currentPoints < cost) return alert("âŒ Ù„Ø§ ØªÙ…Ù„Ùƒ Ù†Ù‚Ø§Ø· ÙƒØ§ÙÙŠØ©!");

    userPointsRef.set(currentPoints - cost);

    db.ref("users")
      .once("value")
      .then((snapshot) => {
        snapshot.forEach((child) => {
          const data = child.val();
          if (data.name === toUser) {
            const receiverRef = db.ref(`users/${child.key}/points`);
            receiverRef.once("value", (snap2) => {
              const receiverPoints = snap2.val() || 0;
              receiverRef.set(receiverPoints + cost);
            });
          }
        });
      });

    db.ref("rooms/" + currentRoom + "/messages").push({
      name: "ğŸ Ù‡Ø¯ÙŠØ©",
      message: `${currentUser} Ø£Ø±Ø³Ù„ ${emoji} Ø¥Ù„Ù‰ ${toUser}`,
      time: new Date().toLocaleTimeString(),
      system: true,
    });
  });
}

function addReaction(msgKey, emoji) {
  const ref = db.ref(`rooms/${currentRoom}/messages/${msgKey}/reactions/${emoji}`);
  ref.once("value", (snapshot) => {
    const users = snapshot.val() || [];
    if (users.includes(currentUser)) {
      ref.set(users.filter((u) => u !== currentUser));
    } else {
      ref.set([...users, currentUser]);
    }
  });
}

function showEmojiPicker(target, msgKey) {
  let picker = document.createElement("div");
  picker.className = "emoji-picker";
  ["â¤ï¸", "ğŸ˜‚", "ğŸ‘", "ğŸ‘", "ğŸ˜®", "ğŸ˜¢"].forEach((e) => {
    let span = document.createElement("span");
    span.textContent = e;
    span.onclick = () => {
      addReaction(msgKey, e);
      document.body.removeChild(picker);
    };
    picker.appendChild(span);
  });
  document.body.appendChild(picker);
  picker.style.left = target.getBoundingClientRect().left + "px";
  picker.style.top = target.getBoundingClientRect().top - 40 + "px";
  picker.style.display = "block";
    }function startCall() {
  const room = document.getElementById("room").value.trim();
  if (room) window.open("https://meet.jit.si/" + room, "_blank");
}

function startVoiceCall() {
  const room = document.getElementById("room").value.trim();
  if (room) window.open("https://meet.jit.si/" + room + "-voice", "_blank");
}

window.addEventListener("beforeunload", function () {
  const roomCode = localStorage.getItem("roomCode");
  const userName = localStorage.getItem("userName");
  if (roomCode && userName && userRef) {
    db.ref("rooms/" + roomCode + "/messages").push({
      name: "ğŸšª Ø§Ù„Ù†Ø¸Ø§Ù…",
      message: `ğŸšª Ù„Ù‚Ø¯ ØºØ§Ø¯Ø± ${userName}`,
      time: new Date().toLocaleTimeString(),
      system: true,
    });
    userRef.update({
      online: false,
      lastSeen: firebase.database.ServerValue.TIMESTAMP,
    });
  }
});function joinRoom() {
  const room = document.getElementById("room").value.trim();
  const name = document.getElementById("username").value.trim();
  if (!room || !name || !userId) return;

  currentRoom = room;
  currentUser = name;
  userRef = db.ref(`rooms/${room}/users/${userId}`);
  const now = Date.now();

  db.ref(`users/${userId}`)
    .once("value")
    .then((snapshot) => {
      if (snapshot.exists()) {
        db.ref(`users/${userId}`).update({ name: currentUser });
      } else {
        db.ref(`users/${userId}`).set({ name: currentUser, points: 0, rank: "beginner" });
      }
    });

  userRef.set({ name: currentUser, online: true, lastSeen: now, rank: currentRank });
  userRef.onDisconnect().update({
    online: false,
    lastSeen: firebase.database.ServerValue.TIMESTAMP,
  });

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø±ØªØ¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙˆØ±Ù‹Ø§ Ù„ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§
  watchUserRank();

  localStorage.setItem("roomCode", currentRoom);
  localStorage.setItem("userName", currentUser);

  db.ref("rooms/" + room + "/messages").off();
  document.getElementById("chat-box").innerHTML = "";

  db.ref("rooms/" + room + "/messages").on("child_added", (snapshot) => {
    const data = snapshot.val();
    const key = snapshot.key;
    addMessageToDOM(key, data);
  });

  db.ref("rooms/" + room + "/messages").on("child_changed", (snapshot) => {
    const data = snapshot.val();
    const key = snapshot.key;
    updateMessageInDOM(key, data);
  });

  db.ref("rooms/" + room + "/messages").on("child_removed", (snapshot) => {
    const key = snapshot.key;
    removeMessageFromDOM(key);
  });

  db.ref(`users/${userId}/points`).on("value", (snap) => {
    document.getElementById("pointsDisplay").textContent = `Ø±ØµÙŠØ¯Ùƒ: ${snap.val() || 0}
