<!DOCTYPE html>  
<html lang="ar">  
<head>  
  <meta charset="UTF-8" />  
  <title>ZEWEIL Private Chat</title>  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>  
  <style>  
    body {  
      background-color: #111;  
      color: white;  
      font-family: Tahoma;  
      display: flex;  
      flex-direction: column;  
      align-items: center;  
      padding: 20px;  
    }  
    h2 {  
      color: #0f0;  
      margin-bottom: 10px;  
    }  
    #chat-box {  
      width: 90%;  
      max-width: 600px;  
      height: 400px;  
      overflow-y: auto;  
      background: #1a1a1a;  
      border-radius: 10px;  
      padding: 15px;  
      margin: 15px 0;  
      display: flex;  
      flex-direction: column;  
    }  
    .message {  
      max-width: 80%;  
      padding: 10px 15px;  
      margin: 8px 0;  
      border-radius: 15px;  
      position: relative;  
      word-wrap: break-word;  
      line-height: 1.4;  
    }  
    .my-message {  
      background-color: #0f0;  
      color: #000;  
      align-self: flex-end;  
      border-bottom-right-radius: 0;  
    }  
    .other-message {  
      background-color: #333;  
      color: #fff;  
      align-self: flex-start;  
      border-bottom-left-radius: 0;  
    }  
    .sender {  
      font-weight: bold;  
      font-size: 0.85em;  
      display: flex;  
      align-items: center;  
    }  
    .time {  
      font-size: 0.75em;  
      opacity: 0.7;  
      margin-top: 4px;  
      text-align: right;  
    }  
    .system-message {  
      color: #888;  
      font-style: italic;  
      text-align: center;  
    }  
    input,  
    button {  
      padding: 10px;  
      border: none;  
      border-radius: 5px;  
      margin: 5px;  
    }  
    input {  
      width: 60%;  
    }  
    #room {  
      width: 200px;  
      margin-bottom: 10px;  
    }  
    button {  
      background-color: #0f0;  
      color: black;  
      cursor: pointer;  
    }  
    .emoji-picker {  
      display: none;  
      background: #222;  
      border: 1px solid #333;  
      border-radius: 8px;  
      position: absolute;  
      bottom: 35px;  
      padding: 6px;  
    }  
    .emoji-picker span {  
      font-size: 20px;  
      cursor: pointer;  
      margin: 3px;  
    }  
    .reactions {  
      display: flex;  
      flex-wrap: wrap;  
      gap: 4px;  
      margin-top: 5px;  
    }  
    .reaction {  
      font-size: 14px;  
      background: #444;  
      padding: 2px 6px;  
      border-radius: 10px;  
    }  
    #onlineToggle {  
      position: absolute;  
      left: 15px;  
      top: 15px;  
      background: #0f0;  
      color: #000;  
      border-radius: 50%;  
      width: 40px;  
      height: 40px;  
      font-size: 20px;  
      font-weight: bold;  
      cursor: pointer;  
      display: flex;  
      align-items: center;  
      justify-content: center;  
    }  
    #onlineList {  
      position: absolute;  
      left: 15px;  
      top: 65px;  
      background: #222;  
      color: white;  
      padding: 10px;  
      border-radius: 8px;  
      display: none;  
      max-height: 300px;  
      overflow-y: auto;  
      min-width: 200px;  
    }  
    #giftShop {  
      margin: 10px 0;  
    }  
    img.rank-icon {  
      width: 50px;  
      height: 50px;  
      margin-left: 5px;  
      vertical-align: middle;  
    }  
  
    /* Ø²Ø± Ù…ØªØ¬Ø± Ø§Ù„Ø±ØªØ¨ Ø«Ø§Ø¨Øª ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† */  
    #shopButton {  
      position: fixed;  
      top: 15px;  
      right: 15px;  
      background-color: #0f0;  
      color: black;  
      font-size: 24px;  
      padding: 10px 14px;  
      border-radius: 50%;  
      cursor: pointer;  
      box-shadow: 0 0 10px #0f0;  
      transition: background-color 0.3s ease, transform 0.2s ease;  
      z-index: 10000;  
      text-decoration: none;  
      display: flex;  
      align-items: center;  
      justify-content: center;  
    }  
    #shopButton:hover {  
      background-color: #0c0;  
      transform: scale(1.1);  
    }  
  </style>  
</head>  
<body>  
  <div id="onlineToggle">ğŸ‘¥</div>  
  <div id="onlineList"></div>  
  
  <!-- Ø²Ø± Ù…ØªØ¬Ø± Ø§Ù„Ø±ØªØ¨ -->  
  <a href="https://zeweil-chat.vercel.app/rank-shop.html" id="shopButton" title="Ù…ØªØ¬Ø± Ø§Ù„Ø±ØªØ¨">ğŸ›’</a>  
  
  <h2>ğŸ” Ø¯Ø±Ø¯Ø´Ø© ZEWEIL Ø§Ù„Ø®Ø§ØµØ©</h2>  
  <input type="text" id="room" placeholder="ğŸ›¡ï¸ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©" />  
  <input type="text" id="username" placeholder="ğŸ¡©â€ğŸ’¬ Ø§Ø³Ù…Ùƒ" />  
  <button onclick="joinRoom()">Ø§Ù†Ø¶Ù…</button>  
  <div id="giftShop">  
    <button onclick="window.open('https://app.fawaterk.com/paymentRequest/show/25451', '_blank')">  
      ğŸ Ø´Ø±Ø§Ø¡ Ù†Ù‚Ø§Ø·  
    </button>  
    <span id="pointsDisplay">Ø±ØµÙŠØ¯Ùƒ: 0 ğŸ¯</span>  
  </div>  
  <div id="chat-box"></div>  
  <input type="text" id="message" placeholder="ğŸ’¬ Ø±Ø³Ø§Ù„ØªÙƒ" />  
  <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>  
  <button onclick="startCall()">ğŸ“¹ Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ</button>  
  <button onclick="startVoiceCall()">ğŸ“ Ù…ÙƒØ§Ù„Ù…Ø© ØµÙˆØªÙŠØ©</button><script>  
const firebaseConfig = {  
  apiKey: "AIzaSyAlim9FOvDcMqTJWINoBCHk3k6DNXS-jTo",  
  authDomain: "zeweil-chat.firebaseapp.com",  
  databaseURL: "https://zeweil-chat-default-rtdb.europe-west1.firebasedatabase.app",  
  projectId: "zeweil-chat",  
  storageBucket: "zeweil-chat.appspot.com",  
  messagingSenderId: "79843372176",  
  appId: "1:79843372176:web:ea511efffae60c2a6cfc15",  
};  
firebase.initializeApp(firebaseConfig);  
const db = firebase.database();  

let currentRoom = "";  
let currentUser = "";  
let userId = localStorage.getItem("savedUserId") || null;  
let userRef = null;  

firebase.auth().onAuthStateChanged((user) => {  
  if (user) {  
    userId = user.uid;  
    localStorage.setItem("savedUserId", userId);  
  } else {  
    firebase.auth().signInAnonymously().catch((error) => {  
      console.error("Auth error:", error.message);  
    });  
  }  
});  

const giftPrices = { "ğŸŒ¹": 5, "ğŸ‰": 10, "ğŸ’": 25, "ğŸ†": 50 };  

document.getElementById("onlineToggle").onclick = () => {  
  const list = document.getElementById("onlineList");  
  list.style.display = list.style.display === "block" ? "none" : "block";  
};  

function getRankImg(rank) {  
  if (!rank) return "";  
  const baseRaw = "https://raw.githubusercontent.com/Z-EWEIL/Zeweil_chat/main/";  
  const filename = `${rank}.png`;  
  return `<img src="${baseRaw}${filename}" alt="${rank}" class="rank-icon" />`;  
}  

// Ù…ØµÙÙˆÙØ© Ù„Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„  
let messagesArray = [];// ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù†ØµÙŠ Ø¥Ù„Ù‰ Timestamp Ø±Ù‚Ù…ÙŠ  
function parseTimeToMs(timeStr) {  
  // ÙˆÙ‚Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ ØµÙŠØºØ© hh:mm:ss AM/PM (locale)  
  // Ù†Ø­Ù† Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª ÙÙ‚Ø· Ù„Ø£Ù†Ù‡ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ù„ÙŠ  
  // Ù„ØªØ­Ø³ÙŠÙ†ØŒ Ù†Ø®Ø²Ù† timeMs Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆÙ†Ø³ØªØ®Ø¯Ù…Ù‡ Ù‡Ù†Ø§  

  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ†Ø§ timeMs Ù…Ø¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ø£ÙØ¶Ù„)ØŒ Ù†Ø³ØªØ®Ø¯Ù…Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©  
  return null;  
}  

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„Ø¯ÙˆÙ… Ø­Ø³Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø²Ù…Ù†ÙŠ  
function renderMessages() {  
  const chatBox = document.getElementById("chat-box");  
  chatBox.innerHTML = "";  

  // Ø±ØªØ¨ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø¨Ø§Ù„Ù…ÙŠÙ„ÙŠ Ø«Ø§Ù†ÙŠØ© ØªØµØ§Ø¹Ø¯ÙŠ (Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„)  
  messagesArray.sort((a, b) => a.timeMs - b.timeMs);  

  for (const msg of messagesArray) {  
    const msgDiv = document.createElement("div");  
    msgDiv.id = msg.key;  
    msgDiv.classList.add("message");  

    if (msg.data.system) {  
      msgDiv.classList.add("system-message");  
      msgDiv.textContent = msg.data.message;  
      chatBox.appendChild(msgDiv);  
      continue;  
    }  

    // Ø­Ø³Ø¨ userId Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ÙŠÙ‘ Ø£Ùˆ Ù„ØºÙŠØ±ÙŠ  
    const isMyMessage = msg.data.userId === userId;  
    msgDiv.classList.add(isMyMessage ? "my-message" : "other-message");  
    msgDiv.ondblclick = () => showEmojiPicker(msgDiv, msg.key);  

    const rankImg = getRankImg(msg.rank || "beginner");  

    msgDiv.innerHTML = `  
      <div class="sender">${msg.data.name} ${rankImg}</div>  
      <div class="message-content">${msg.data.message}</div>  
      <div class="time">${msg.data.time}</div>  
    `;  

    if (isMyMessage) {  
      const editBtn = document.createElement("button");  
      editBtn.textContent = "âœï¸";  
      editBtn.title = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©";  
      editBtn.style.marginLeft = "5px";  
      editBtn.onclick = () => editMessage(msg.key);  

      const deleteBtn = document.createElement("button");  
      deleteBtn.textContent = "ğŸ—‘ï¸";  
      deleteBtn.title = "Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©";  
      deleteBtn.style.marginLeft = "5px";  
      deleteBtn.onclick = () => deleteMessage(msg.key);  

      msgDiv.appendChild(editBtn);  
      msgDiv.appendChild(deleteBtn);  
    }  

    const giftBtn = document.createElement("button");  
    giftBtn.textContent = "ğŸ";  
    giftBtn.onclick = () => sendGift(msg.data.name);  
    msgDiv.appendChild(giftBtn);  

    const reactionsDiv = document.createElement("div");  
    reactionsDiv.className = "reactions";  
    if (msg.data.reactions) {  
      Object.entries(msg.data.reactions).forEach(([emoji, users]) => {  
        if (users.length > 0) {  
          const r = document.createElement("div");  
          r.className = "reaction";  
          r.textContent = `${emoji} ${users.length}`;  
          reactionsDiv.appendChild(r);  
        }  
      });  
    }  

    msgDiv.appendChild(reactionsDiv);  
    chatBox.appendChild(msgDiv);  
  }  

  // Ø§Ø¬Ø¹Ù„ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø³ÙÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ø±Ø¶ (Ø­ØªÙ‰ Ù„Ùˆ ØªØ±ØªÙŠØ¨ Ù‚Ø¯ÙŠÙ…)  
  chatBox.scrollTop = chatBox.scrollHeight;  
    }function addMessageToArray(key, data) {  
  // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ÙŠØ³Øª Ù…ÙƒØ±Ø±Ø©  
  if (messagesArray.find(m => m.key === key)) return;  

  // Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙˆÙ‚Øª Ø¨Ø§Ù„Ù…ÙŠÙ„ÙŠ Ø«Ø§Ù†ÙŠØ© Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø§Ø­Ø³Ù† Ù…Ù† time Ù†ØµÙŠ)  
  // Ø§Ù„Ø£ÙØ¶Ù„: ØªØ®Ø²ÙŠÙ† ÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù…ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø©  
  let timeMs = Date.now();  
  if (data.timeMs) {  
    timeMs = data.timeMs;  
  } else if (data.time) {  
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ ÙˆÙ‚Øª Ø±Ù‚Ù…ÙŠØŒ Ù†ÙÙƒØ± ÙÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„ØŒ Ù„ÙƒÙ† Ø§Ù„Ø£ÙØ¶Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„  
    // Ù…Ù…ÙƒÙ† ØªØ¬Ø§Ù‡Ù„ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ  
  }  

  // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø±ØªØ¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†) - Ø³Ù†Ø¶Ø¹ Ø±ØªØ¨Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø§Ù„Ø¢Ù†  
  let rank = "beginner";  

  messagesArray.push({ key, data, timeMs, rank });  

  // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„  
  renderMessages();  
}  

function updateMessageInArray(key, data) {  
  const msgIndex = messagesArray.findIndex(m => m.key === key);  
  if (msgIndex === -1) return;  

  messagesArray[msgIndex].data = data;  
  // Ù„Ø§ Ù†ØºÙŠØ± Ø§Ù„ÙˆÙ‚Øª Ù‡Ù†Ø§ Ù„ØªØ¬Ù†Ø¨ ÙÙˆØ¶Ù‰  
  renderMessages();  
}  

function removeMessageFromArray(key) {  
  messagesArray = messagesArray.filter(m => m.key !== key);  
  renderMessages();  
}function sendMessage() {  
  const msg = document.getElementById("message").value.trim();  
  if (!currentRoom || !currentUser || !msg) return;  

  db.ref("rooms/" + currentRoom + "/messages").push({  
    userId: userId,  
    name: currentUser,  
    message: msg,  
    time: new Date().toLocaleTimeString(),  
    timeMs: Date.now(),  // ØªØ®Ø²ÙŠÙ† Ø§Ù„ÙˆÙ‚Øª Ø±Ù‚Ù…ÙŠ  
    reactions: {},  
  });  
  document.getElementById("message").value = "";  
    }function joinRoom() {  
  const room = document.getElementById("room").value.trim();  
  const name = document.getElementById("username").value.trim();  
  if (!room || !name || !userId) return;  

  currentRoom = room;  
  currentUser = name;  
  userRef = db.ref(`rooms/${room}/users/${userId}`);  
  const now = Date.now();  

  db.ref(`users/${userId}`)  
    .once("value")  
    .then((snapshot) => {  
      if (snapshot.exists()) {  
        db.ref(`users/${userId}`).update({ name: currentUser });  
      } else {  
        db.ref(`users/${userId}`).set({ name: currentUser, points: 0 });  
      }  
    });  

  userRef.set({ name: currentUser, online: true, lastSeen: now, rank: "beginner" });  
  userRef.onDisconnect().update({  
    online: false,  
    lastSeen: firebase.database.ServerValue.TIMESTAMP,  
  });  

  localStorage.setItem("roomCode", currentRoom);  
  localStorage.setItem("userName", currentUser);  

  // Ø§ÙØµÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰ (Ù„ØªØ¬Ù†Ø¨ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø£Ø­Ø¯Ø§Ø«)  
  db.ref("rooms/" + room + "/messages").off();  
  messagesArray = [];  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©  

  db.ref("rooms/" + room + "/messages").on("child_added", (snapshot) => {  
    const data = snapshot.val();  
    const key = snapshot.key;  
    addMessageToArray(key, data);  
  });  

  db.ref("rooms/" + room + "/messages").on("child_changed", (snapshot) => {  
    const data = snapshot.val();  
    const key = snapshot.key;  
    updateMessageInArray(key, data);  
  });  

  db.ref("rooms/" + room + "/messages").on("child_removed", (snapshot) => {  
    const key = snapshot.key;  
    removeMessageFromArray(key);  
  });  

  db.ref(`users/${userId}/points`).on("value", (snap) => {  
    document.getElementById("pointsDisplay").textContent = `Ø±ØµÙŠØ¯Ùƒ: ${snap.val() || 0} ğŸ¯`;  
  });  

  db.ref(`rooms/${room}/users`).on("value", (snapshot) => {  
    const list = document.getElementById("onlineList");  
    list.innerHTML = "<strong>ğŸ‘¥ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡:</strong><br><br>";  
    snapshot.forEach((child) => {const user = child.val();  
      const userName = user.name || "Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„";  
      const isOnline = user.online ? "ğŸŸ¢" : "âšª";  
      const rank = user.rank || "beginner";  
      list.innerHTML += `${isOnline} ${userName} ${getRankImg(rank)}<br>`;  
    });  
  });  
}  

function editMessage(key) {  
  const msg = messagesArray.find(m => m.key === key);  
  if (!msg) return alert("Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");  
  if (msg.data.userId !== userId) return alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ØºÙŠØ±Ùƒ");  

  const newMsg = prompt("Ø¹Ø¯Ù„ Ø±Ø³Ø§Ù„ØªÙƒ:", msg.data.message);  
  if (newMsg === null) return; // Ø¥Ù„ØºØ§Ø¡  

  db.ref(`rooms/${currentRoom}/messages/${key}`).update({  
    message: newMsg,  
    // ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª Ù„ÙƒÙ† Ù†ÙØ¶Ù„ Ù„Ø§  
  });  
}  

function deleteMessage(key) {  
  const msg = messagesArray.find(m => m.key === key);  
  if (!msg) return alert("Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");  
  if (msg.data.userId !== userId) return alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© ØºÙŠØ±Ùƒ");  

  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ")) {  
    db.ref(`rooms/${currentRoom}/messages/${key}`).remove();  
  }  
}  

function sendGift(toUserName) {  
  if (!currentRoom || !currentUser) return;  
  if (toUserName === currentUser) return alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ© Ù„Ù†ÙØ³Ùƒ");  

  const gift = prompt("Ø§Ø®ØªØ± Ù‡Ø¯ÙŠØ© ØªØ±Ø³Ù„Ù‡Ø§ (ğŸŒ¹ØŒ ğŸ‰ØŒ ğŸ’ØŒ ğŸ†):");  
  if (!giftPrices[gift]) return alert("Ù‡Ø¯ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©");  

  const userPointsRef = db.ref(`users/${userId}/points`);  
  userPointsRef.once("value").then(snapshot => {  
    const points = snapshot.val() || 0;  
    if (points < giftPrices[gift]) {  
      alert("Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ Ù„Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù‡Ø¯ÙŠØ©");  
      return;  
    }  

    // Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† Ø§Ù„Ù…Ø±Ø³Ù„  
    userPointsRef.set(points - giftPrices[gift]);  

    // ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªÙ„Ù…  
    db.ref(`users`).orderByChild("name").equalTo(toUserName).once("value", snap => {  
      let found = false;  
      snap.forEach(childSnap => {  
        const uid = childSnap.key;  
        const recipientPoints = childSnap.val().points || 0;  
        db.ref(`users/${uid}/points`).set(recipientPoints + giftPrices[gift]);  
        found = true;  
      });  
      if (!found) alert("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");  
    });  

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†Ø¸Ø§Ù…ÙŠØ© ØªØ¹Ù„Ù† Ø¹Ù† Ø§Ù„Ù‡Ø¯ÙŠØ©  
    db.ref(`rooms/${currentRoom}/messages`).push({  
      userId: "system",  
      name: "Ù†Ø¸Ø§Ù…",  
      message: `${currentUser} Ø£Ø±Ø³Ù„ Ù‡Ø¯ÙŠØ© ${gift} Ù„Ù€ ${toUserName}!`,  
      time: new Date().toLocaleTimeString(),  
      timeMs: Date.now(),  
      system: true,  
    });  
  });  
}// Ù…Ø«Ø§Ù„ Ø¨Ø³ÙŠØ· Ù„ØªØ´ØºÙŠÙ„ Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ Ø¹Ø¨Ø± Jitsi  
function startCall() {  
  if (!currentRoom) return alert("Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ© Ø£ÙˆÙ„Ø§Ù‹");  
  const domain = "meet.jit.si";  
  const options = {  
    roomName: "ZEWEIL_CHAT_" + currentRoom,  
    width: 700,  
    height: 500,  
    parentNode: null,  
  };  
  window.open(`https://${domain}/${options.roomName}`, "_blank", "width=700,height=500");  
}  

function startVoiceCall() {  
  if (!currentRoom) return alert("Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ© Ø£ÙˆÙ„Ø§Ù‹");  
  const domain = "meet.jit.si";  
  const options = {  
    roomName: "ZEWEIL_VOICE_" + currentRoom,  
    width: 500,  
    height: 300,  
    parentNode: null,  
  };  
  window.open(`https://${domain}/${options.roomName}`, "_blank", "width=500,height=300");  
}  

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ø®ØªÙŠØ§Ø± Ø¥ÙŠÙ…ÙˆØ¬ÙŠ (ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ±Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§)  
function showEmojiPicker(msgDiv, messageKey) {  
  let picker = msgDiv.querySelector(".emoji-picker");  
  if (picker) {  
    picker.style.display = picker.style.display === "block" ? "none" : "block";  
    return;  
  }  

  picker = document.createElement("div");  
  picker.className = "emoji-picker";  
  const emojis = ["ğŸ‘", "â¤ï¸", "ğŸ˜‚", "ğŸ˜®", "ğŸ˜¢", "ğŸ‘"];  
  emojis.forEach((emoji) => {  
    const span = document.createElement("span");  
    span.textContent = emoji;  
    span.onclick = () => addReaction(messageKey, emoji);  
    picker.appendChild(span);  
  });  
  msgDiv.appendChild(picker);  
  picker.style.display = "block";  
}  

function addReaction(messageKey, emoji) {  
  if (!currentRoom) return;  
  const msgRef = db.ref(`rooms/${currentRoom}/messages/${messageKey}/reactions`);  
  msgRef.transaction((currentReactions) => {  
    if (currentReactions === null) currentReactions = {};  
    if (!currentReactions[emoji]) currentReactions[emoji] = [];  

    if (!currentReactions[emoji].includes(currentUser)) {  
      currentReactions[emoji].push(currentUser);  
    } else {  
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)  
      currentReactions[emoji] = currentReactions[emoji].filter(u => u !== currentUser);  
      if (currentReactions[emoji].length === 0) delete currentReactions[emoji];  
    }  
    return currentReactions;  
  });  
}  
</script>  
</body>  
</html>window.addEventListener("beforeunload", function () {
  if (currentRoom && currentUser && userRef) {
    db.ref("rooms/" + currentRoom + "/messages").push({
      userId: "system",
      name: "ğŸšª Ø§Ù„Ù†Ø¸Ø§Ù…",
      message: `ğŸšª Ù„Ù‚Ø¯ ØºØ§Ø¯Ø± ${currentUser}`,
      time: new Date().toLocaleTimeString(),
      timeMs: Date.now(),
      system: true,
    });
    userRef.update({
      online: false,
      lastSeen: firebase.database.ServerValue.TIMESTAMP,
    });
  }
});
