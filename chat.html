<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>ZEWEIL Private Chat</title>
  <style>
    body {
      font-family: Arial;
      background: #111;
      color: white;
      margin: 0;
      padding: 0;
    }
    #chat {
      height: 400px;
      overflow-y: scroll;
      border: 1px solid #333;
      padding: 10px;
      margin-bottom: 10px;
    }
    input, button {
      padding: 8px;
      margin: 5px;
    }
    .hidden {
      display: none;
    }
    .settings-panel {
      background: #222;
      padding: 15px;
      position: absolute;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      border: 1px solid #555;
      display: none;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

<h2>ZEWEIL Private Chat</h2>
<div id="chat"></div>

<input type="text" id="messageInput" placeholder="اكتب رسالتك...">
<button onclick="sendMessage()">إرسال</button>
<span id="typingStatus"></span>
<br>

<button onclick="toggleSettings()">⚙️ إعدادات</button>
<button id="reviewBtn" onclick="checkReview()" class="hidden">لوحة المراجعة</button>

<div class="settings-panel" id="settingsPanel">
  <h3>إعدادات الحساب</h3>
  <p>اسم المستخدم الحالي: <span id="currentName"></span></p>
  <input type="text" id="newName" placeholder="اسم جديد">
  <button onclick="requestNameChange()">طلب تغيير الاسم</button>
  <button onclick="closeSettings()">إغلاق</button>
</div>

<script>
  const firebaseConfig = {
    // بيانات Firebase هنا
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const room = "room1";

  let username = localStorage.getItem("username");
  if (!username) {
    username = prompt("ادخل اسمك:");
    localStorage.setItem("username", username);
    db.ref(`rooms/${room}/users/${username}`).set({ online: true, lastSeen: Date.now() });
    db.ref(`rooms/${room}/messages`).push({ text: `لقد انضم ${username} إلى الغرفة`, sender: "System", time: Date.now() });
  } else {
    db.ref(`rooms/${room}/users/${username}`).set({ online: true, lastSeen: Date.now() });
  }

  document.getElementById("currentName").innerText = username;

  function sendMessage() {
    const text = document.getElementById("messageInput").value;
    db.ref(`rooms/${room}/messages`).push({ text, sender: username, time: Date.now() });
    document.getElementById("messageInput").value = "";
  }

  // عرض الرسائل
  db.ref(`rooms/${room}/messages`).on("child_added", (snapshot) => {
    const msg = snapshot.val();
    const div = document.createElement("div");
    div.textContent = `${msg.sender}: ${msg.text}`;
    document.getElementById("chat").appendChild(div);
    document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
  });

  // تحديث "يكتب الآن"
  let typingTimeout;
  document.getElementById("messageInput").addEventListener("input", () => {
    db.ref(`rooms/${room}/typing/${username}`).set(true);
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
      db.ref(`rooms/${room}/typing/${username}`).remove();
    }, 2000);
  });

  db.ref(`rooms/${room}/typing`).on("value", (snapshot) => {
    const data = snapshot.val() || {};
    const typingUsers = Object.keys(data).filter(name => name !== username);
    document.getElementById("typingStatus").innerText = typingUsers.length ? `${typingUsers.join(", ")} بيكتب...` : "";
  });

  // زر الإعدادات
  function toggleSettings() {
    document.getElementById("settingsPanel").style.display = "block";
  }
  function closeSettings() {
    document.getElementById("settingsPanel").style.display = "none";
  }

  // طلب تغيير الاسم
  function requestNameChange() {
    const newName = document.getElementById("newName").value;
    if (newName && newName !== username) {
      db.ref(`name_change_requests/${username}`).set({
        from: username,
        to: newName,
        status: "pending",
        time: Date.now()
      });
      alert("تم إرسال طلب تغيير الاسم إلى الأدمن.");
    }
  }

  // زر لوحة المراجعة السري
  document.addEventListener("keydown", function(e) {
    if (e.ctrlKey && e.key === "x") {
      const pass = prompt("ادخل كلمة مرور الأدمن:");
      if (pass === "zeweil admin") {
        document.getElementById("reviewBtn").classList.remove("hidden");
      }
    }
  });

  function checkReview() {
    window.location.href = "review_panel.html";
  }

  // آخر ظهور
  window.addEventListener("beforeunload", () => {
    db.ref(`rooms/${room}/users/${username}`).update({ online: false, lastSeen: Date.now() });
  });
</script>

</body>
</html>
