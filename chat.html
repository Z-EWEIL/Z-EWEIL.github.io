<!DOCTYPE html><html>
<head>
  <title>ZEWEIL Chat</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body { background: #000; color: #fff; font-family: Arial; }
    #chat { max-width: 600px; margin: auto; padding: 20px; background: #111; border-radius: 10px; }
    #messages { height: 300px; overflow-y: scroll; border: 1px solid #333; padding: 10px; margin-bottom: 10px; }
    .message { margin-bottom: 5px; }
    .status-bar { font-size: 0.8em; color: #aaa; margin-bottom: 10px; }
    .online { color: #0f0; }
    .offline { color: #f00; }
  </style>
</head>
<body>
  <div id="chat">
    <div class="status-bar">
      <span id="statusDisplay">ØºÙŠØ± Ù…ØªØµÙ„</span> | <span id="typingStatus"></span> | <span id="lastSeen"></span>
    </div>
    <div id="messages"></div>
    <input type="text" id="message" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
    <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
    <button onclick="startCall()">ðŸ“ž Ù…ÙƒØ§Ù„Ù…Ø©</button>
  </div>  <script>
    const firebaseConfig = {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentRoom = "room1";
    let currentUser = prompt("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ:");
    let typingTimeout;
    let knownUsers = [];

    function sendMessage() {
      const msg = document.getElementById("message").value;
      if (msg) {
        db.ref(`chat/${currentRoom}`).push({ name: currentUser, text: msg });
        document.getElementById("message").value = "";
        setTyping(false);
      }
    }

    function startCall() {
      const url = `https://meet.jit.si/ZEWEIL-${currentRoom}`;
      window.open(url, "_blank");
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    db.ref(`chat/${currentRoom}`).on("child_added", (snapshot) => {
      const msg = snapshot.val();
      const div = document.createElement("div");
      div.classList.add("message");
      div.innerText = `${msg.name}: ${msg.text}`;
      document.getElementById("messages").appendChild(div);
    });

    // Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
    document.getElementById("message").addEventListener("input", () => {
      setTyping(true);
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => setTyping(false), 2000);
    });

    function setTyping(status) {
      db.ref(`status/${currentRoom}/${currentUser}`).update({
        typing: status,
        lastSeen: new Date().toLocaleTimeString(),
        online: true
      });
    }

    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø­Ø§Ù„Ø©
    db.ref(`status/${currentRoom}`).on("value", (snapshot) => {
      const users = snapshot.val();
      let someoneTyping = false;
      let lastSeenText = "";
      let onlineStatus = "ØºÙŠØ± Ù…ØªØµÙ„";

      for (let user in users) {
        if (user !== currentUser) {
          if (users[user].typing) someoneTyping = true;
          if (users[user].lastSeen) lastSeenText = `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±: ${users[user].lastSeen}`;
          onlineStatus = users[user].online ? "<span class='online'>Ù…ØªØµÙ„</span>" : "<span class='offline'>ØºÙŠØ± Ù…ØªØµÙ„</span>";
        }
      }

      document.getElementById("typingStatus").innerText = someoneTyping ? "ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†..." : "";
      document.getElementById("lastSeen").innerHTML = lastSeenText;
      document.getElementById("statusDisplay").innerHTML = onlineStatus;
    });

    // ØªÙ†Ø¨ÙŠÙ‡ Ø¯Ø®ÙˆÙ„
    db.ref(`status/${currentRoom}`).on("child_added", (snapshot) => {
      const user = snapshot.key;
      if (!knownUsers.includes(user) && user !== currentUser) {
        knownUsers.push(user);
        alert(`${user} Ø¯Ø®Ù„ Ø§Ù„ØºØ±ÙØ© ðŸ‘‹`);
      }
    });

    // Ø§Ù„Ø®Ø±ÙˆØ¬ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
    window.addEventListener("beforeunload", () => {
      db.ref(`status/${currentRoom}/${currentUser}`).update({
        typing: false,
        online: false,
        lastSeen: new Date().toLocaleTimeString()
      });
    });

    // Ø£ÙˆÙ„ Ø¯Ø®ÙˆÙ„
    db.ref(`status/${currentRoom}/${currentUser}`).set({
      typing: false,
      online: true,
      lastSeen: new Date().toLocaleTimeString()
    });
  </script></body>
</html>
